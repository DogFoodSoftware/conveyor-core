#!/bin/bash

# Check baseline assumptions.
ERROR=false
if [ x"$USER" != x"user" ]; then
    echo "Conveyor 0.1 only supports installation by user 'user'." >&2
    ERROR=true
fi
if [ x"$HOME" != x"/home/user" ]; then
    echo "Conveyor 0.1 expects 'user' home to be '/home/user'." >&2
    ERROR=true
fi
DISTRO_SUPPORT_STATEMENT="Conveyor 0.1 supports openSuSE 12.3 and 13.1."
if [ ! -f /etc/SuSE-release ]; then
    echo $DISTRO_SUPPORT_STATEMENT >&2
else
    source /etc/SuSE-release
    case "$VERSION" in
	12.3|13.1)
	    ;; # that's fine
	*) # anything else though...
	    echo $DISTRO_SUPPORT_STATEMENT >&2
	    ERROR=true
	    ;;
    esac
fi
if [[ `sudo -n echo foo 2>/dev/null` != 'foo' ]]; then
    echo "Conveyor expects user to have full 'sudo' no-password privileges." >&2
    ERROR=true
fi
if [ x"$ERROR" == x"true" ]; then
    echo "Consider using using the Conveyor vagrant VM: TODO".
    exit 1
fi
# Baseline assumptions checked, time to start installing.

# Unlike all other Conveyor scripts, this one is designed to be runnable
# outside of a playground and because this is the script that creates the
# playground. So, we define our baseline directory locations here rather than
# rely on the standard 'default_config.sh' to set locations.
export CONVEYOR_PLAYGROUND=/home/user/playground
export DFS_HOME=$CONVEYOR_PLAYGROUND/dogfoodsoftware.com
export CONVEYOR_HOME=$DFS_HOME/conveyor

# Again, we would normally use 'shflags' library here as a third-party
# Conveyor standard component, but since this is a standalone, we use getopt
# directly.
TMP=`getopt --name=$0 -a --longoptions=default-branch: -o b: -- $@`
eval set -- $TMP

until [ $1 == -- ]; do
    case $1 in
        -b|--default-branch)
            DEFAULT_BRANCH=$2
            shift;; # Remove option value.
    esac
    shift # Remove just-processed option.
done
shift # Remove the '--', now $1 positioned at first argument if any.
if [ x"$DEFAULT_BRANCH" == x"" ]; then
    DEFAULT_BRANCH=production
fi

if [ -d $CONVEYOR_PLAYGROUND ]; then
    echo "It looks like Conveyor is already installed. To re-install, delete" >&2
    echo "'$CONVEYOR_PLAYGROUND' and re-run this script." >&2
    ERROR=true
fi
if [ -f $HOME/.conveyor/config ]; then
    echo 'Found $HOME/.conveyor/config file already in place. Please delete and re-run' >&2
    echo 'installation script.' >&2
    ERROR=true
fi
if [ x"$ERROR" == x"true" ]; then
    exit 1
fi

mkdir -p $DFS_HOME
cd $DFS_HOME

git clone https://github.com/DogFoodSoftware/conveyor.git --branch $DEFAULT_BRANCH conveyor

source $CONVEYOR_HOME/conf/conveyor-project-dependencies.sh

for REQUIRED_PROJECT in $REQUIRED_PROJECTS; do
    $CONVEYOR_HOME/bin/conveyor-project-install -b $DEFAULT_BRANCH $REQUIRED_PROJECT
    TODO: check results
done
